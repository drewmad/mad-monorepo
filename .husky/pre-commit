#!/usr/bin/env sh

# Run lint-staged for code formatting
npx lint-staged

# Check for common import issues
echo "üîç Checking imports..."

# Check for subpath imports (quick check on staged files only)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
  for file in $STAGED_FILES; do
    # Check for @ui subpath imports
    if grep -E "from ['\"]@ui/" "$file" 2>/dev/null; then
      echo "‚ùå Error: Found @ui subpath import in $file"
      echo "   Change to: import { Component } from '@ui';"
      exit 1
    fi
    
    # Check for @db subpath imports (excluding types)
    if grep -E "from ['\"]@db/" "$file" 2>/dev/null | grep -v "from ['\"]@db/types"; then
      echo "‚ùå Error: Found @db subpath import in $file"
      echo "   Change to: import { function } from '@db';"
      exit 1
    fi
  done
fi

# Check if package.json changed but pnpm-lock.yaml didn't
if git diff --cached --name-only | grep -E "package\.json$" > /dev/null; then
  if ! git diff --cached --name-only | grep "pnpm-lock.yaml" > /dev/null; then
    echo "‚ö†Ô∏è  package.json changed but pnpm-lock.yaml wasn't updated"
    echo "Run 'pnpm install' to update the lockfile"
    exit 1
  fi
fi

# Check if pnpm-lock.yaml exists
if [ ! -f "pnpm-lock.yaml" ]; then
  echo "‚ùå pnpm-lock.yaml is missing!"
  echo "Run 'pnpm install' to generate it"
  exit 1
fi

echo "‚úÖ Pre-commit checks passed"